<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quem é o Impostor? - AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
        }

        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .game-state { display: none; }
        .game-state.active { display: block; }

        @keyframes gradient-x {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animate-gradient-x {
            background-size: 200% 200%;
            animation: gradient-x 3s ease infinite;
        }
    </style>
</head>
<body class="text-slate-100 p-4 md:p-8">

    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-black tracking-tighter text-red-500 mb-1 flex items-center justify-center gap-2">
                <i data-lucide="shield-alert" class="w-8 h-8 text-red-600"></i> QUEM É O IMPOSTOR?
            </h1>
            <p id="game-subtitle" class="text-slate-500 text-sm uppercase tracking-widest font-bold">Configuração do Jogo</p>
        </header>

        <!-- SETUP STATE -->
        <div id="state-setup" class="game-state active bg-slate-900 rounded-2xl p-6 shadow-xl border border-slate-800 space-y-6">
            <div class="grid grid-cols-2 gap-4 bg-slate-800/30 p-4 rounded-xl border border-slate-800">
                <div>
                    <label class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase mb-2">
                        <i data-lucide="users" class="w-4 h-4"></i> Total Jogadores
                    </label>
                    <input title="input-num-players" type="number" id="input-num-players" min="3" max="50" value="12" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-red-500 transition-all">
                </div>
                <div>
                    <label class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase mb-2">
                        <i data-lucide="ghost" class="w-4 h-4"></i> Impostores
                    </label>
                    <input title="input-num-impostors" type="number" id="input-num-impostors" min="1" max="10" value="3" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-red-500 transition-all">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Palavra Secreta:</label>
                <div class="flex gap-2 relative">
                    <div class="relative flex-1">
                        <input title="input-secret-word" type="password" id="input-secret-word" placeholder="Clique em 'IA' ou digite..."
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl pl-4 pr-12 py-3 focus:ring-2 focus:ring-red-500 outline-none transition-all font-mono">
                        <button title="toggle-secret-visibility" type="button" onclick="toggleSecretVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition-colors">
                            <i data-lucide="eye" id="eye-icon" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button title="btn-ia" onclick="fetchGeminiWord()" id="btn-ia" class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded-xl transition-all border border-indigo-500 flex items-center justify-center min-w-[60px]">
                        <i data-lucide="sparkles" id="ia-icon" class="w-5 h-5"></i>
                    </button>
                </div>
                <p id="api-error" class="text-red-400 text-[10px] mt-1 font-bold hidden"></p>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nomes dos Jogadores:</label>
                <div id="player-names-list" class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Gerado via JS -->
                </div>
            </div>

            <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-red-900/20">
                <i data-lucide="play" class="w-5 h-5 fill-current"></i> INICIAR JOGO
            </button>
        </div>

        <!-- REVEAL STATE -->
        <div id="state-reveal" class="game-state text-center space-y-6">
            <div>
                <div class="inline-flex items-center justify-center w-16 h-16 bg-slate-800 rounded-full mb-3 text-slate-400">
                    <i data-lucide="user" class="w-8 h-8"></i>
                </div>
                <h2 id="current-player-name" class="text-2xl font-bold uppercase">Nome do Jogador</h2>
                <p class="text-slate-400 text-sm">Pegue o dispositivo para ver seu papel</p>
            </div>

            <div id="card-container" onclick="toggleReveal()" class="relative h-64 w-full rounded-3xl cursor-pointer transition-all duration-500 preserve-3d">
                <!-- Frente -->
                <div class="absolute inset-0 bg-slate-800 border-2 border-slate-700 rounded-3xl flex flex-col items-center justify-center backface-hidden">
                    <i data-lucide="eye" class="w-12 h-12 text-slate-500 mb-4"></i>
                    <span class="font-bold text-slate-300 uppercase tracking-widest text-sm">Toque para revelar</span>
                </div>
                <!-- Verso -->
                <div id="card-back" class="absolute inset-0 rounded-3xl flex flex-col items-center justify-center backface-hidden rotate-y-180">
                    <div id="role-icon-container"></div>
                    <h3 id="role-title" class="text-3xl font-black mb-1 italic">ROLE</h3>
                    <p id="role-detail" class="text-xs uppercase px-6 text-center"></p>
                </div>
            </div>

            <div class="mt-8 space-y-6">
                <button id="btn-next-player" onclick="handleNextPlayer()" disabled class="w-full py-4 rounded-xl font-bold transition-all bg-slate-800 text-slate-600 cursor-not-allowed">
                    ESCONDER E PASSAR
                </button>
                <div id="progress-dots" class="flex justify-center gap-1"></div>
            </div>
        </div>

        <!-- PLAYING & VOTING STATE -->
        <div id="state-playing" class="game-state space-y-6">
            <div class="bg-slate-900 rounded-2xl p-6 border border-slate-800 shadow-2xl">
                <div class="text-center mb-6">
                    <h2 id="voting-title" class="text-2xl font-black italic text-white uppercase">VOTAÇÃO FINAL</h2>
                    <p id="voting-subtitle" class="text-slate-400 text-xs mt-1">Selecione os suspeitos</p>
                </div>

                <div id="voting-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-6">
                    <!-- Gerado via JS -->
                </div>

                <div class="space-y-3">
                    <button id="btn-confirm-votes" onclick="confirmVotes()" disabled class="w-full py-4 rounded-xl font-black uppercase transition-all bg-slate-800 text-slate-600 cursor-not-allowed shadow-lg">
                        CONFIRMAR VOTOS
                    </button>
                    <button onclick="resetGame()" class="w-full py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 font-bold flex items-center justify-center gap-2 border border-slate-700 transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> REINICIAR TUDO
                    </button>
                </div>
            </div>

            <div id="results-footer" class="hidden bg-slate-900/50 p-6 rounded-xl border border-slate-800 text-center">
                <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1">A Palavra era:</p>
                <p id="final-word-reveal" class="text-2xl font-black text-white uppercase tracking-[0.2em]"></p>
            </div>
        </div>
    </div>

    <script>
        // Configurações e Estado
        const apiKey = "";
        let state = {
            phase: 'setup',
            numPlayers: 12,
            numImpostors: 3,
            secretWord: '',
            playerNames: [],
            players: [],
            revealIndex: 0,
            isRevealed: false,
            selectedVotes: [],
            isGenerating: false
        };

        // Inicialização
        function init() {
            updatePlayerInputs();
            lucide.createIcons();
            
            // Listeners para Inputs Numéricos
            document.getElementById('input-num-players').addEventListener('change', (e) => {
                state.numPlayers = Math.max(3, parseInt(e.target.value) || 3);
                e.target.value = state.numPlayers;
                
                // Garantir impostores válidos
                const maxImp = state.numPlayers - 2;
                if (state.numImpostors > maxImp) {
                    state.numImpostors = maxImp;
                    document.getElementById('input-num-impostors').value = maxImp;
                }
                updatePlayerInputs();
            });

            document.getElementById('input-num-impostors').addEventListener('change', (e) => {
                const maxAllowed = state.numPlayers - 2;
                state.numImpostors = Math.min(maxAllowed, Math.max(1, parseInt(e.target.value) || 1));
                e.target.value = state.numImpostors;
            });
        }

        // --- Lógica de Setup ---
        function updatePlayerInputs() {
            const container = document.getElementById('player-names-list');
            container.innerHTML = '';
            state.playerNames = [];

            for (let i = 0; i < state.numPlayers; i++) {
                const name = `Jogador ${i + 1}`;
                state.playerNames.push(name);

                const div = document.createElement('div');
                div.className = "flex items-center gap-2 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 group focus-within:border-slate-500";
                div.innerHTML = `
                    <span class="text-[10px] text-slate-500 font-mono w-4">${i + 1}</span>
                    <input type="text" value="${name}" onchange="updatePlayerName(${i}, this.value)" 
                        class="bg-transparent border-none w-full text-sm focus:ring-0 outline-none placeholder-slate-600">
                `;
                container.appendChild(div);
            }
        }

        function updatePlayerName(index, value) {
            state.playerNames[index] = value || `Jogador ${index + 1}`;
        }

        function toggleSecretVisibility() {
            const input = document.getElementById('input-secret-word');
            const icon = document.getElementById('eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        // --- Gemini API ---
        async function fetchGeminiWord() {
            if (state.isGenerating) return;
            
            state.isGenerating = true;
            const btn = document.getElementById('btn-ia');
            const icon = document.getElementById('ia-icon');
            const errorText = document.getElementById('api-error');
            
            btn.classList.add('animate-pulse');
            icon.setAttribute('data-lucide', 'loader-2');
            icon.classList.add('animate-spin');
            errorText.classList.add('hidden');
            lucide.createIcons();

            const systemPrompt = "Você é um assistente para o jogo 'Quem é o Impostor?'. Gere uma única palavra secreta em português (Brasil). A palavra deve ser um substantivo concreto, objeto, animal ou lugar comum. Retorne APENAS a palavra.";
            const userQuery = "Gere uma palavra aleatória criativa.";

            const fetchWithRetry = async (retries = 5, delay = 1000) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    if (!response.ok) throw new Error();
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                } catch (e) {
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, delay));
                        return fetchWithRetry(retries - 1, delay * 2);
                    }
                    throw e;
                }
            };

            try {
                const word = await fetchWithRetry();
                document.getElementById('input-secret-word').value = word;
                state.secretWord = word;
            } catch (err) {
                errorText.innerText = "Falha na IA. Digite manualmente.";
                errorText.classList.remove('hidden');
            } finally {
                state.isGenerating = false;
                btn.classList.remove('animate-pulse');
                icon.setAttribute('data-lucide', 'sparkles');
                icon.classList.remove('animate-spin');
                lucide.createIcons();
            }
        }

        // --- Fluxo do Jogo ---
        function startGame() {
            const wordInput = document.getElementById('input-secret-word').value.trim();
            if (!wordInput) {
                alert("Por favor, defina a palavra!");
                return;
            }
            state.secretWord = wordInput;

            // Sortear Impostores
            let indices = Array.from({ length: state.numPlayers }, (_, i) => i);
            indices.sort(() => Math.random() - 0.5);
            const impostorIndices = indices.slice(0, state.numImpostors);

            state.players = state.playerNames.map((name, i) => ({
                id: i,
                name: name,
                isImpostor: impostorIndices.includes(i),
                word: impostorIndices.includes(i) ? 'VOCÊ É O IMPOSTOR' : state.secretWord
            }));

            state.revealIndex = 0;
            state.isRevealed = false;
            state.selectedVotes = [];
            
            renderReveal();
            switchState('reveal');
        }

        function switchState(phase) {
            state.phase = phase;
            document.querySelectorAll('.game-state').forEach(el => el.classList.remove('active'));
            document.getElementById(`state-${phase}`).classList.add('active');
            
            const subtitle = document.getElementById('game-subtitle');
            if (phase === 'reveal') subtitle.innerText = `${state.numPlayers} JOGADORES • ${state.numImpostors} IMPOSTORES`;
            if (phase === 'playing') subtitle.innerText = "FASE DE VOTAÇÃO";
        }

        // --- Fase de Revelação ---
        function renderReveal() {
            const player = state.players[state.revealIndex];
            document.getElementById('current-player-name').innerText = player.name;
            
            const cardBack = document.getElementById('card-back');
            const iconCont = document.getElementById('role-icon-container');
            const title = document.getElementById('role-title');
            const detail = document.getElementById('role-detail');

            iconCont.innerHTML = '';
            const icon = document.createElement('i');
            
            if (player.isImpostor) {
                cardBack.className = "absolute inset-0 rounded-3xl flex flex-col items-center justify-center backface-hidden rotate-y-180 bg-red-950 border-red-500 border-2 shadow-[0_0_30px_rgba(239,68,68,0.2)]";
                icon.setAttribute('data-lucide', 'ghost');
                icon.className = "w-16 h-16 text-red-500 mb-4 animate-pulse";
                title.innerText = "IMPOSTOR";
                title.className = "text-3xl font-black text-red-500 mb-1 italic";
                detail.innerText = "Tente descobrir o que os inocentes estão descrevendo!";
                detail.className = "text-red-300 px-6 text-xs uppercase text-center";
            } else {
                cardBack.className = "absolute inset-0 rounded-3xl flex flex-col items-center justify-center backface-hidden rotate-y-180 bg-green-950 border-green-500 border-2 shadow-[0_0_30px_rgba(34,197,94,0.2)]";
                icon.setAttribute('data-lucide', 'check-circle-2');
                icon.className = "w-16 h-16 text-green-500 mb-4";
                title.innerText = player.word;
                title.className = "text-3xl font-black text-white uppercase tracking-widest px-4 text-center";
                detail.innerText = "SUA PALAVRA SECRETA";
                detail.className = "text-green-400 font-bold text-[10px] uppercase tracking-widest mb-1";
            }
            iconCont.appendChild(icon);

            // Dots
            const dots = document.getElementById('progress-dots');
            dots.innerHTML = '';
            state.players.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `h-1.5 rounded-full transition-all ${i === state.revealIndex ? 'w-4 bg-red-500' : 'w-1.5 bg-slate-800'}`;
                dots.appendChild(dot);
            });

            // Reset Card
            document.getElementById('card-container').classList.remove('rotate-y-180');
            state.isRevealed = false;
            updateNextBtn();
            lucide.createIcons();
        }

        function toggleReveal() {
            state.isRevealed = !state.isRevealed;
            const card = document.getElementById('card-container');
            if (state.isRevealed) card.classList.add('rotate-y-180');
            else card.classList.remove('rotate-y-180');
            updateNextBtn();
        }

        function updateNextBtn() {
            const btn = document.getElementById('btn-next-player');
            if (state.isRevealed) {
                btn.disabled = false;
                btn.className = "w-full py-4 rounded-xl font-bold transition-all shadow-lg bg-indigo-600 hover:bg-indigo-500 text-white";
                btn.innerText = state.revealIndex < state.players.length - 1 ? 'ESCONDER E PASSAR' : 'IR PARA O JOGO';
            } else {
                btn.disabled = true;
                btn.className = "w-full py-4 rounded-xl font-bold transition-all bg-slate-800 text-slate-600 cursor-not-allowed";
                btn.innerText = "ESCONDER E PASSAR";
            }
        }

        function handleNextPlayer() {
            if (state.revealIndex < state.players.length - 1) {
                state.revealIndex++;
                renderReveal();
            } else {
                renderVoting();
                switchState('playing');
            }
        }

        // --- Fase de Votação ---
        function renderVoting() {
            const grid = document.getElementById('voting-grid');
            grid.innerHTML = '';
            
            state.players.forEach(player => {
                const isSelected = state.selectedVotes.includes(player.id);
                const btn = document.createElement('div');
                btn.id = `voter-${player.id}`;
                btn.onclick = () => toggleVote(player.id);
                btn.className = `relative flex items-center justify-between p-3 rounded-xl border-2 transition-all cursor-pointer ${isSelected ? 'bg-indigo-900/30 border-indigo-500 text-white shadow-lg' : 'bg-slate-800/50 border-slate-700 text-slate-400 hover:border-slate-600'}`;
                
                btn.innerHTML = `
                    <span class="font-bold text-sm truncate pr-2">${player.name}</span>
                    <div class="icon-slot shrink-0">${isSelected ? '<i data-lucide="check" class="w-4 h-4 text-indigo-400"></i>' : ''}</div>
                `;
                grid.appendChild(btn);
            });
            
            document.getElementById('results-footer').classList.add('hidden');
            document.getElementById('voting-title').innerText = "QUEM SÃO OS IMPOSTORES?";
            document.getElementById('voting-subtitle').innerText = `Selecione os ${state.numImpostors} suspeitos (${state.selectedVotes.length}/${state.numImpostors})`;
            
            const confirmBtn = document.getElementById('btn-confirm-votes');
            confirmBtn.classList.remove('hidden');
            confirmBtn.disabled = true;
            confirmBtn.className = "w-full py-4 rounded-xl font-black uppercase transition-all bg-slate-800 text-slate-600 cursor-not-allowed shadow-lg";

            lucide.createIcons();
        }

        function toggleVote(id) {
            if (state.phase !== 'playing') return;

            const idx = state.selectedVotes.indexOf(id);
            if (idx > -1) {
                state.selectedVotes.splice(idx, 1);
            } else if (state.selectedVotes.length < state.numImpostors) {
                state.selectedVotes.push(id);
            }
            
            renderVoting();
            
            const confirmBtn = document.getElementById('btn-confirm-votes');
            if (state.selectedVotes.length === state.numImpostors) {
                confirmBtn.disabled = false;
                confirmBtn.className = "w-full py-4 rounded-xl font-black uppercase transition-all bg-red-600 hover:bg-red-500 text-white shadow-red-900/20 shadow-lg";
            }
        }

        function confirmVotes() {
            state.phase = 'results';
            document.getElementById('voting-title').innerText = "REVELAÇÃO FINAL";
            document.getElementById('voting-subtitle').innerText = "Confira quem eram os traidores!";
            document.getElementById('btn-confirm-votes').classList.add('hidden');
            
            // Renderizar Resultados nos Cards
            state.players.forEach(player => {
                const card = document.getElementById(`voter-${player.id}`);
                const iconSlot = card.querySelector('.icon-slot');
                const isVoted = state.selectedVotes.includes(player.id);
                const missed = !isVoted && player.isImpostor;
                const correct = isVoted && player.isImpostor;
                const wrong = isVoted && !player.isImpostor;

                iconSlot.innerHTML = '';
                if (correct) {
                    card.className = "relative flex items-center justify-between p-3 rounded-xl border-2 bg-green-900/30 border-green-500 text-green-100";
                    iconSlot.innerHTML = '<i data-lucide="ghost" class="w-4 h-4 text-red-500 animate-pulse"></i>';
                } else if (wrong) {
                    card.className = "relative flex items-center justify-between p-3 rounded-xl border-2 bg-red-900/30 border-red-500 text-red-100";
                    iconSlot.innerHTML = '<i data-lucide="x" class="w-4 h-4 text-red-500"></i>';
                } else if (missed) {
                    card.className = "relative flex items-center justify-between p-3 rounded-xl border-2 bg-yellow-900/10 border-yellow-600 border-dashed text-yellow-200";
                    iconSlot.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4 text-yellow-500"></i>';
                } else {
                    card.className = "relative flex items-center justify-between p-3 rounded-xl border-2 bg-slate-800/20 border-slate-800 text-slate-600";
                }
            });

            document.getElementById('results-footer').classList.remove('hidden');
            document.getElementById('final-word-reveal').innerText = state.secretWord;
            lucide.createIcons();
        }

        function resetGame() {
            document.getElementById('input-secret-word').value = '';
            state.secretWord = '';
            switchState('setup');
        }

        // Rodar ao iniciar
        window.onload = init;
    </script>
</body>
</html>