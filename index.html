<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quem é o Impostor? - Votação Individual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
        }

        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .game-state { display: none; }
        .game-state.active { display: block; }
    </style>
</head>
<body class="text-slate-100 p-4 md:p-8">

    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-black tracking-tighter text-red-500 mb-1 flex items-center justify-center gap-2">
                <i data-lucide="shield-alert" class="w-8 h-8 text-red-600"></i> QUEM É O IMPOSTOR?
            </h1>
            <p id="game-subtitle" class="text-slate-500 text-sm uppercase tracking-widest font-bold">Configuração do Jogo</p>
        </header>

        <!-- SETUP STATE -->
        <div id="state-setup" class="game-state active bg-slate-900 rounded-2xl p-6 shadow-xl border border-slate-800 space-y-6">
            <div class="grid grid-cols-2 gap-4 bg-slate-800/30 p-4 rounded-xl border border-slate-800">
                <div>
                    <label class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase mb-2">
                        <i data-lucide="users" class="w-4 h-4"></i> Total Jogadores
                    </label>
                    <input title="Número total de jogadores" type="number" id="input-num-players" min="3" max="50" value="12" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-red-500 transition-all">
                </div>
                <div>
                    <label class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase mb-2">
                        <i data-lucide="ghost" class="w-4 h-4"></i> Impostores
                    </label>
                    <input title="Número de impostores" type="number" id="input-num-impostors" min="1" max="10" value="3" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-red-500 transition-all">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Palavra Secreta:</label>
                <div class="flex gap-2 relative">
                    <div class="relative flex-1">
                        <input title="Palavra secreta" type="password" id="input-secret-word" placeholder="Sorteie ou digite..."
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl pl-4 pr-12 py-3 focus:ring-2 focus:ring-red-500 outline-none transition-all font-mono">
                        <button title="Mostrar/Ocultar palavra secreta" type="button" onclick="toggleSecretVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition-colors">
                            <i data-lucide="eye" id="eye-icon" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button title="Sorteie uma palavra aleatória" onclick="fetchRandomWord()" id="btn-ia" class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded-xl transition-all border border-indigo-500 flex items-center justify-center min-w-[60px]">
                        <i data-lucide="dice-5" id="ia-icon" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nomes dos Jogadores:</label>
                <div id="player-names-list" class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>

            <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-red-900/20">
                <i data-lucide="play" class="w-5 h-5 fill-current"></i> INICIAR JOGO
            </button>
        </div>

        <!-- REVEAL STATE -->
        <div id="state-reveal" class="game-state text-center space-y-6">
            <div>
                <div class="inline-flex items-center justify-center w-16 h-16 bg-slate-800 rounded-full mb-3 text-slate-400">
                    <i data-lucide="user" class="w-8 h-8"></i>
                </div>
                <p class="text-slate-400 text-sm">Passe o dispositivo para:</p>
                <h2 id="current-player-name" class="text-2xl font-bold uppercase">Nome</h2>
            </div>

            <div id="card-container" onclick="toggleReveal()" class="relative h-64 w-full rounded-3xl cursor-pointer transition-all duration-500 preserve-3d">
                <div class="absolute inset-0 bg-slate-800 border-2 border-slate-700 rounded-3xl flex flex-col items-center justify-center backface-hidden">
                    <i data-lucide="eye" class="w-12 h-12 text-slate-500 mb-4"></i>
                    <span class="font-bold text-slate-300 uppercase tracking-widest text-sm">Revelar papel</span>
                </div>
                <div id="card-back" class="absolute inset-0 rounded-3xl flex flex-col items-center justify-center backface-hidden rotate-y-180 border-2">
                    <div id="role-icon-container"></div>
                    <h3 id="role-title" class="text-3xl font-black mb-1 italic">ROLE</h3>
                    <p id="role-detail" class="text-xs uppercase px-6 text-center"></p>
                </div>
            </div>

            <div class="mt-8 space-y-6">
                <button id="btn-next-player" onclick="handleNextPlayer()" disabled class="w-full py-4 rounded-xl font-bold transition-all bg-slate-800 text-slate-600 cursor-not-allowed">
                    CONFIRMEI
                </button>
                <div id="progress-dots" class="flex justify-center gap-1"></div>
            </div>
        </div>

        <!-- INDIVIDUAL VOTING STATE -->
        <div id="state-voting" class="game-state space-y-6">
            <div class="bg-slate-900 rounded-2xl p-6 border border-slate-800 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-indigo-900/30 rounded-full mb-3 text-indigo-400">
                        <i data-lucide="vote" class="w-6 h-6"></i>
                    </div>
                    <p class="text-slate-400 text-xs">Vez de votar de:</p>
                    <h2 id="voting-player-name" class="text-2xl font-black italic text-white uppercase italic">NOME</h2>
                    <p id="voting-instructions" class="text-slate-500 text-[10px] mt-1 uppercase">Selecione 3 suspeitos</p>
                </div>

                <div id="voting-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-6"></div>

                <button id="btn-confirm-voter" onclick="submitIndividualVote()" disabled class="w-full py-4 rounded-xl font-black uppercase transition-all bg-slate-800 text-slate-600 cursor-not-allowed shadow-lg">
                    CONFIRMAR MEUS VOTOS
                </button>
            </div>
        </div>

        <!-- FINAL RESULTS STATE -->
        <div id="state-results" class="game-state space-y-6">
            <div id="game-result-banner" class="animate-in zoom-in duration-500">
                <div id="banner-bg" class="rounded-2xl p-6 text-center shadow-2xl border-2 mb-4">
                    <h2 id="result-status" class="text-4xl font-black italic mb-2">RESULTADO</h2>
                    <p id="result-message" class="text-sm uppercase tracking-widest font-bold"></p>
                </div>
            </div>

            <div class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 text-center">Apuração dos Votos</h3>
                <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
            </div>

            <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-800 text-center">
                <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1 italic">A Palavra era:</p>
                <p id="final-word-reveal" class="text-2xl font-black text-white uppercase tracking-[0.2em]"></p>
                
                <button onclick="resetGame()" class="mt-6 w-full py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 font-bold flex items-center justify-center gap-2 border border-slate-700 transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> JOGAR NOVAMENTE
                </button>
            </div>
        </div>
    </div>

    <script>
        const WORD_POOL = [
            "Acesso", "Ação", "Abrigo", "Apoio", "Base", "Brilho", "Busca", "Ciclo", "Corte", "Carga",
            "Curso", "Canto", "Centro", "Chave", "Choque", "Corrente", "Causa", "Dado", "Dobra", "Dúvida",
            "Efeito", "Elo", "Entrada", "Estado", "Fase", "Fator", "Fim", "Fluxo", "Fogo", "Fonte",
            "Frente", "Fundo", "Giro", "Grau", "Guarda", "Guia", "Hábito", "Idade", "Impacto", "Índice",
            "Início", "Instante", "Juro", "Laço", "Lado", "Lance", "Limite", "Linha", "Livre", "Lugar",
            "Marcha", "Marca", "Meio", "Medida", "Mente", "Meta", "Modo", "Monte", "Movimento", "Mudança",
            "Nível", "Nota", "Objeto", "Ordem", "Origem", "Pacto", "Parada", "Parte", "Passo", "Pausa",
            "Ponto", "Porte", "Posto", "Prazo", "Preço", "Prática", "Prova", "Queda", "Quadro", "Razão",
            "Rede", "Regra", "Relação", "Reserva", "Resto", "Risco", "Rumo", "Salto", "Série", "Sinal",
            "Sistema", "Sorte", "Status", "Termo", "Tipo", "Traço", "Troca", "Uso", "Valor", "Volta"
        ];

        let state = {
            phase: 'setup',
            numPlayers: 12,
            numImpostors: 3,
            secretWord: '',
            playerNames: [],
            players: [], // {id, name, isImpostor, word, voteCount}
            revealIndex: 0,
            votingIndex: 0,
            isRevealed: false,
            currentVoterPicks: [],
            usedWords: []
        };

        function init() {
            updatePlayerInputs();
            lucide.createIcons();
            
            document.getElementById('input-num-players').addEventListener('change', (e) => {
                state.numPlayers = Math.max(3, parseInt(e.target.value) || 3);
                const maxImp = Math.floor(state.numPlayers / 2); // Limite de 50%
                if (state.numImpostors > maxImp) state.numImpostors = maxImp;
                document.getElementById('input-num-impostors').max = maxImp;
                updatePlayerInputs();
            });

            document.getElementById('input-num-impostors').addEventListener('change', (e) => {
                const maxAllowed = Math.floor(state.numPlayers / 2);
                state.numImpostors = Math.min(maxAllowed, Math.max(1, parseInt(e.target.value) || 1));
                e.target.value = state.numImpostors;
            });
        }

        function updatePlayerInputs() {
            const container = document.getElementById('player-names-list');
            container.innerHTML = '';
            state.playerNames = [];
            for (let i = 0; i < state.numPlayers; i++) {
                const name = `Jogador ${i + 1}`;
                state.playerNames.push(name);
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 group focus-within:border-slate-500";
                div.innerHTML = `<span class="text-[10px] text-slate-500 font-mono w-4">${i + 1}</span>
                    <input type="text" value="${name}" onchange="state.playerNames[${i}] = this.value" 
                    class="bg-transparent border-none w-full text-sm focus:ring-0 outline-none placeholder-slate-600">`;
                container.appendChild(div);
            }
        }

        function toggleSecretVisibility() {
            const input = document.getElementById('input-secret-word');
            const icon = document.getElementById('eye-icon');
            input.type = input.type === 'password' ? 'text' : 'password';
            icon.setAttribute('data-lucide', input.type === 'password' ? 'eye' : 'eye-off');
            lucide.createIcons();
        }

        function fetchRandomWord() {
            const available = WORD_POOL.filter(w => !state.usedWords.includes(w));
            const pool = available.length > 0 ? available : WORD_POOL;
            const word = pool[Math.floor(Math.random() * pool.length)];
            state.secretWord = word;
            state.usedWords.push(word);
            document.getElementById('input-secret-word').value = word;
            const icon = document.getElementById('ia-icon');
            icon.classList.add('animate-spin');
            setTimeout(() => icon.classList.remove('animate-spin'), 500);
        }

        function startGame() {
            const wordInput = document.getElementById('input-secret-word').value.trim();
            if (!wordInput) return alert("Defina a palavra!");
            state.secretWord = wordInput;

            let indices = Array.from({ length: state.numPlayers }, (_, i) => i).sort(() => Math.random() - 0.5);
            const impostorIndices = indices.slice(0, state.numImpostors);

            state.players = state.playerNames.map((name, i) => ({
                id: i,
                name: name,
                isImpostor: impostorIndices.includes(i),
                word: impostorIndices.includes(i) ? 'VOCÊ É O IMPOSTOR' : state.secretWord,
                voteCount: 0
            }));

            state.revealIndex = 0;
            renderReveal();
            switchState('reveal');
        }

        function switchState(phase) {
            state.phase = phase;
            document.querySelectorAll('.game-state').forEach(el => el.classList.remove('active'));
            document.getElementById(`state-${phase}`).classList.add('active');
            const subtitle = document.getElementById('game-subtitle');
            if (phase === 'reveal') subtitle.innerText = "Revelação de Papéis";
            if (phase === 'voting') subtitle.innerText = "Votação Individual";
            if (phase === 'results') subtitle.innerText = "Resultado Final";
        }

        // --- REVEAL LOGIC ---
        function renderReveal() {
            const player = state.players[state.revealIndex];
            document.getElementById('current-player-name').innerText = player.name;
            document.getElementById('card-container').classList.remove('rotate-y-180');
            state.isRevealed = false;
            
            setTimeout(() =>{
                const cardBack = document.getElementById('card-back');
                const iconCont = document.getElementById('role-icon-container');
                const title = document.getElementById('role-title');
                const detail = document.getElementById('role-detail');

                iconCont.innerHTML = `<i data-lucide="${player.isImpostor ? 'ghost' : 'check-circle-2'}" class="w-16 h-16 mb-4 ${player.isImpostor ? 'text-red-500 animate-pulse' : 'text-green-500'}"></i>`;
                cardBack.className = `absolute inset-0 rounded-3xl flex flex-col items-center justify-center backface-hidden rotate-y-180 border-2 ${player.isImpostor ? 'bg-red-950 border-red-500 shadow-lg shadow-red-500/20' : 'bg-green-950 border-green-500 shadow-lg shadow-green-500/20'}`;
                title.innerText = player.word;
                title.className = `text-3xl font-black uppercase tracking-widest text-center px-4 ${player.isImpostor ? 'text-red-500' : 'text-white'}`;
                detail.innerText = player.isImpostor ? "Descubra quem é o inocente!" : "Mantenha sigilo sobre sua palavra!";
                
                const dots = document.getElementById('progress-dots');
                dots.innerHTML = state.players.map((_, i) => `<div class="h-1.5 rounded-full transition-all ${i === state.revealIndex ? 'w-4 bg-red-500' : 'w-1.5 bg-slate-800'}"></div>`).join('');
                
                updateNextBtn();
                lucide.createIcons();
            }, 300);
        }

        function toggleReveal() {
            state.isRevealed = true;
            document.getElementById('card-container').classList.add('rotate-y-180');
            updateNextBtn();
        }

        function updateNextBtn() {
            const btn = document.getElementById('btn-next-player');
            btn.disabled = !state.isRevealed;
            btn.className = `w-full py-4 rounded-xl font-bold transition-all ${state.isRevealed ? 'bg-red-600 text-white shadow-lg shadow-red-900/20' : 'bg-slate-800 text-slate-600 cursor-not-allowed'}`;
        }

        function handleNextPlayer() {
            if (state.revealIndex < state.players.length - 1) {
                state.revealIndex++;
                renderReveal();
            } else {
                startIndividualVoting();
            }
        }

        // --- INDIVIDUAL VOTING LOGIC ---
        function startIndividualVoting() {
            state.votingIndex = 0;
            state.currentVoterPicks = [];
            renderIndividualVoter();
            switchState('voting');
        }

        function renderIndividualVoter() {
            const voter = state.players[state.votingIndex];
            document.getElementById('voting-player-name').innerText = voter.name;
            document.getElementById('voting-instructions').innerText = `Selecione seus ${state.numImpostors} suspeitos`;
            
            state.currentVoterPicks = [];
            const grid = document.getElementById('voting-grid');
            grid.innerHTML = state.players.map(p => {
                const isSelf = p.id === voter.id;
                return `<div id="choice-${p.id}" onclick="toggleVoterChoice(${p.id})" 
                    class="flex items-center justify-between p-3 rounded-xl border-2 cursor-pointer transition-all ${isSelf ? 'opacity-30 pointer-events-none' : ''} bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-600">
                    <span class="font-bold text-sm">${p.name}</span>
                    <div class="icon-slot"></div>
                </div>`;
            }).join('');

            updateIndividualConfirmBtn();
            lucide.createIcons();
        }

        function toggleVoterChoice(id) {
            const idx = state.currentVoterPicks.indexOf(id);
            const card = document.getElementById(`choice-${id}`);
            const iconSlot = card.querySelector('.icon-slot');

            if (idx > -1) {
                state.currentVoterPicks.splice(idx, 1);
                card.className = "flex items-center justify-between p-3 rounded-xl border-2 cursor-pointer transition-all bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-600";
                iconSlot.innerHTML = '';
            } else if (state.currentVoterPicks.length < state.numImpostors) {
                state.currentVoterPicks.push(id);
                card.className = "flex items-center justify-between p-3 rounded-xl border-2 cursor-pointer transition-all bg-indigo-900/40 border-indigo-500 text-white shadow-md";
                iconSlot.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-indigo-400"></i>';
            }
            updateIndividualConfirmBtn();
            lucide.createIcons();
        }

        function updateIndividualConfirmBtn() {
            const btn = document.getElementById('btn-confirm-voter');
            const isFull = state.currentVoterPicks.length === state.numImpostors;
            btn.disabled = !isFull;
            btn.className = `w-full py-4 rounded-xl font-black uppercase transition-all ${isFull ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800 text-slate-600'}`;
        }

        function submitIndividualVote() {
            state.currentVoterPicks.forEach(id => {
                state.players[id].voteCount++;
            });

            if (state.votingIndex < state.players.length - 1) {
                state.votingIndex++;
                renderIndividualVoter();
                window.scrollTo(0, 0);
            } else {
                calculateFinalResults();
            }
        }

        // --- RESULTS LOGIC ---
        function calculateFinalResults() {
            // 1. Ordenar por mais votados
            const sortedPlayers = [...state.players].sort((a, b) => b.voteCount - a.voteCount);
            
            // 2. Pegar os top X (número de impostores)
            const accusedIndices = sortedPlayers.slice(0, state.numImpostors).map(p => p.id);
            
            let correctHits = 0; // Impostores pegos
            let wrongHits = 0;   // Inocentes acusados

            accusedIndices.forEach(id => {
                if (state.players[id].isImpostor) correctHits++;
                else wrongHits++;
            });

            // NOVA REGRA: Impostores desmascarados < Inocentes acusados no grupo final, os Inocentes perdem.
            const inocentesPerdem = correctHits < wrongHits;

            renderFinalScreen(accusedIndices, inocentesPerdem, correctHits, wrongHits);
            switchState('results');
        }

        function renderFinalScreen(accusedIndices, inocentesPerdem, correctHits, wrongHits) {
            const banner = document.getElementById('game-result-banner');
            const status = document.getElementById('result-status');
            const message = document.getElementById('result-message');
            const bg = document.getElementById('banner-bg');

            if (inocentesPerdem) {
                status.innerText = "IMPOSTORES VENCERAM!";
                message.innerText = `${correctHits} Impostores vs ${wrongHits} Inocentes no Top Votos. Os Inocentes falharam!`;
                bg.className = "rounded-2xl p-6 text-center shadow-2xl border-2 mb-4 bg-red-950 border-red-500 text-red-500";
            } else {
                status.innerText = "INOCENTES VENCERAM!";
                message.innerText = `${correctHits} Impostores vs ${wrongHits} Inocentes no Top Votos. Os Inocentes triunfaram!`;
                bg.className = "rounded-2xl p-6 text-center shadow-2xl border-2 mb-4 bg-green-950 border-green-500 text-green-500";
            }

            const grid = document.getElementById('results-grid');
            grid.innerHTML = state.players.map(p => {
                const isAccused = accusedIndices.includes(p.id);
                let style = "flex items-center justify-between p-3 rounded-xl border-2 ";
                let icons = "";

                if (p.isImpostor) {
                    style += isAccused ? "bg-green-900/30 border-green-500 text-green-100" : "bg-yellow-900/10 border-yellow-600 border-dashed text-yellow-500";
                    icons = '<i data-lucide="ghost" class="w-4 h-4 text-red-500"></i>';
                } else if (isAccused) {
                    style += "bg-red-900/30 border-red-500 text-red-100";
                    icons = '<i data-lucide="x" class="w-4 h-4 text-red-500"></i>';
                } else {
                    style += "bg-slate-800/20 border-slate-800 text-slate-500";
                }

                return `<div class="${style}">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-mono opacity-50">${p.voteCount}v</span>
                        <span class="font-bold text-sm">${p.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        ${isAccused ? '<span class="text-[8px] font-black bg-slate-100/10 px-1 rounded">ACUSADO</span>' : ''}
                        ${icons}
                    </div>
                </div>`;
            }).join('');

            document.getElementById('final-word-reveal').innerText = state.secretWord;
            lucide.createIcons();
        }

        function resetGame() {
            state.revealIndex = 0;
            state.votingIndex = 0;
            state.players = [];
            document.getElementById('input-secret-word').value = '';
            switchState('setup');
        }

        window.onload = init;
    </script>
</body>
</html>